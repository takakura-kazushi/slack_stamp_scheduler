# ✅ Slack Bot: Stamp Scheduler - 要件定義書（改訂版）

Slack のリアクション(スタンプ)を用いて日程調整を簡単に行い、日程決定後は従ってリマインドを送信する Slack ボット。

---

## 1. プロジェクト概要

Slack 上での**日程調整をリアクション（スタンプ）で完結できるボット**を開発する。  
ボットは Slack 上で以下をサポートする：

- 候補日投稿 → リアクションで参加表明
- 管理者による最終決定 → 決定メッセージから日程確定
- 確定メンバーへの**自動リマインド**

目的は、**直感的・省力的な UX**の提供と、**Slack における非同期な日程調整**の効率化。

---

## 2. 使用シーン（ユースケース）

### 想定例：

1. 師義（幹事）が次のように投稿（Bot をメンション）：

   ```
   @stampbot
   今週のミーティング候補日：
   :one: 月曜 10:00〜
   :two: 火曜 14:00〜
   :three: 水曜 16:00〜

   スタンプで出欠お願いします！
   ```

2. メンバーがリアクションでスタンプを押す（参加意思）

3. 師義がスレッドで決定、Bot を再度メンション：

   ```
   @stampbot 日程は :two: 火曜 14:00〜 にします．
   ```

4. Bot が決定されたスタンプに対応するユーザーを取得し、日程と紐付け

5. イベント前日に自動で DM リマインドを送信

---

## 3. 必須機能

### 3.1 候補投稿の検出・記録

- Bot がメンションされたメッセージを対象とする
- 含まれるリアクションスタンプとそれに対応する日程テキストを抽出
- 候補メッセージの `ts` を記録

### 3.2 リアクションの収集

- Slack `reaction_added` イベントを購読
- 特定の候補投稿メッセージ（`ts`）に対して付けられたスタンプを記録
- スタンプごとに参加者（ユーザー ID）を記録

### 3.3 決定メッセージの検出

- スレッド内の返信メッセージを監視
- Bot がメンションされていて、スタンプ（例：`:two:`）が本文に含まれるかをチェック
- 決定スタンプを記録し、`emoji_to_datetime` マップから対応日時を確定

### 3.4 リマインド予約と送信

- APScheduler を用いて、決定された日時の前日にタスクを登録
- 対象ユーザーに DM で通知（`chat.postMessage`）

---

## 4. データベース設計(最終的な DB スキーマ)

| カラム名            | データ型    | 内容                                                                             |
| :------------------ | :---------- | :------------------------------------------------------------------------------- |
| `main_message_ts`   | `text`      | **[主キー]** 候補日を投稿した親メッセージのタイムスタンプ。                      |
| `channel_id`        | `text`      | イベントが作成されたチャンネルの ID。                                            |
| `options`           | `jsonb`     | 候補となるスタンプと日時の対応マップ（例: `{":one:": "2025-07-10T10:00:00"}`）。 |
| `participants`      | `jsonb`     | スタンプごとの参加者リスト（例: `{":one:": ["U012A3BC4", "U567D8EF9"]}`）。      |
| `selected_emoji`    | `text`      | 最終決定されたスタンプ（例: `":one:"`）。                                        |
| `selected_datetime` | `timestamp` | 最終決定された日時。                                                             |
| `reminder_job_id`   | `text`      | APScheduler など、スケジューラに登録したジョブの ID。                            |
| `is_reminder_sent`  | `boolean`   | リマインドが送信済みかどうかのフラグ。デフォルトは`false`。                      |
| `created_at`        | `timestamp` | このレコードが作成された日時。                                                   |

---

## 5. UI/UX 設計（Bot の発言形式）

### 候補投稿時：

Bot は以下のように記録確認のメッセージを返す：

```
候補日を記録しました！スタンプで出欠をお願いします！

:one: 月曜 10:00〜
:two: 火曜 14:00〜
:three: 水曜 16:00〜
```

### 決定時：

Bot は以下のようにレスポンスを返す：

```
以下の内容で確定しました。
日程：火曜 14:00〜
参加者：@user1, @user2, ...

リマインドは前日にDMでお送りします！
```

---

## 6. 開発スタック

- 言語：Python（FastAPI）
- DB：Supabase
- スケジューラ：APScheduler
- Slack 連携：Bolt SDK or Slack Web API（直接）

---

## 7. 今後の発展

- Google Calendar 連携（予定作成 & 招待）
- 参加者数が一定に達したら**自動で締切・確定**
- 複数チャンネル・複数イベントの並列管理
- 管理者 UI（管理画面）や Webhook の追加

---

## 8. 補足ポリシー

- Bot は補助的な役割に徹する
- 日程決定はあくまで**人間の明示的アクション**（メンション＋スタンプ指定）によって行う
- 自動で日程を決めることは（オプション扱いとしても）**初期段階では行わない**

---

## セットアップ手順

1.  **リポジトリのクローン**
    ```bash
    git clone https://github.com/takakura-kazushi/slack_stamp_scheduler.git
    ```
2.  **仮想環境の作成と有効化**
    ```bash
    python -m venv venv
    source venv/bin/activate
    ```
3.  **依存ライブラリのインストール**
    ```bash
    pip install -r requirements.txt
    ```
4.  **環境変数の設定**
    `.env.example`をコピーして`.env`ファイルを作成し、以下の値を設定してください。

    - `SLACK_BOT_TOKEN`: あなたの Slack Bot トークン
    - `SUPABASE_URL`: Supabase プロジェクトの URL
    - `SUPABASE_KEY`: Supabase プロジェクトの anon キー

5.  **データベースの準備**
    Supabase プロジェクトでテーブルを作成してください。スキーマは`## データベース設計`のセクションを参照。

## 開発環境での起動手順

1.  **FastAPI サーバーの起動**
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ```
2.  **一時的な公開 URL の生成**
    ```bash
    ngrok http 8000
    ```
3.  **Slack API に Request URL を登録**
    ngrok で生成された URL の末尾に`/slack/events`を付け、Slack アプリの Event Subscriptions に登録します。

---
